{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourceRoot": "dist",
  "sourcesContent": ["export interface Env {\n  R2_BUCKET: R2Bucket\n  THUMBNAIL_WORKER_SECRET: string\n  R2_PUBLIC_BASE_URL?: string\n}\n\ntype R2Bucket = {\n  get: (key: string) => Promise<R2Object | null>\n  put: (\n    key: string,\n    value: ReadableStream | ArrayBuffer | Uint8Array,\n    options?: { httpMetadata?: { contentType?: string } },\n  ) => Promise<unknown>\n}\n\ntype R2Object = {\n  body: ReadableStream | null\n}\n\ntype ThumbnailPayload = {\n  jobId?: string\n}\n\nfunction normalizeUrl(value: unknown) {\n  if (typeof value !== \"string\") return null\n  const trimmed = value.replace(/`/g, \"\").trim()\n  if (!trimmed) return null\n  if (!/^https?:\\/\\//i.test(trimmed)) return null\n  return trimmed\n}\n\nfunction buildPublicUrl(base: string | undefined, key: string) {\n  if (!base) return key\n  const trimmedBase = base.replace(/\\/+$/, \"\")\n  const trimmedKey = key.replace(/^\\/+/, \"\")\n  return `${trimmedBase}/${trimmedKey}`\n}\n\nexport default {\n  async fetch(request: Request, env: Env): Promise<Response> {\n    try {\n      const url = new URL(request.url)\n\n      if (url.pathname !== \"/thumbnail\") {\n        return new Response(\"Not found\", { status: 404 })\n      }\n\n      const secret = env.THUMBNAIL_WORKER_SECRET || \"\"\n      const headerSecret = request.headers.get(\"x-api-key\") || \"\"\n      if (!secret || !headerSecret || secret !== headerSecret) {\n        return new Response(JSON.stringify({ error: \"Unauthorized\" }), {\n          status: 401,\n          headers: { \"content-type\": \"application/json\" },\n        })\n      }\n\n      const payload = (await request.json().catch(() => ({}))) as ThumbnailPayload\n      const jobId = typeof payload.jobId === \"string\" ? payload.jobId : \"\"\n\n      if (!jobId) {\n        return new Response(JSON.stringify({ error: \"Missing jobId\" }), {\n          status: 400,\n          headers: { \"content-type\": \"application/json\" },\n        })\n      }\n\n      const thumbnailKey = `sora-thumbnails/${jobId}.jpg`\n      const bucket = env.R2_BUCKET\n\n      const existing = await bucket.get(thumbnailKey)\n      if (existing && existing.body) {\n        const existingUrl = buildPublicUrl(env.R2_PUBLIC_BASE_URL, thumbnailKey)\n        return new Response(JSON.stringify({ ok: true, r2ThumbnailUrl: existingUrl }), {\n          status: 200,\n          headers: { \"content-type\": \"application/json\" },\n        })\n      }\n\n      return new Response(\n        JSON.stringify({ error: \"Thumbnail not found in R2\", r2ThumbnailKey: thumbnailKey }),\n        {\n          status: 404,\n          headers: { \"content-type\": \"application/json\" },\n        },\n      )\n    } catch (error) {\n      const message =\n        error && typeof (error as any).message === \"string\"\n          ? (error as any).message\n          : \"Unknown error\"\n      return new Response(JSON.stringify({ error: \"Internal worker error\", detail: message }), {\n        status: 500,\n        headers: { \"content-type\": \"application/json\" },\n      })\n    }\n  },\n}\n"],
  "mappings": ";;;;AA+BA,SAAS,eAAe,MAA0B,KAAa;AAC7D,MAAI,CAAC,KAAM,QAAO;AAClB,QAAM,cAAc,KAAK,QAAQ,QAAQ,EAAE;AAC3C,QAAM,aAAa,IAAI,QAAQ,QAAQ,EAAE;AACzC,SAAO,GAAG,WAAW,IAAI,UAAU;AACrC;AALS;AAOT,IAAO,gBAAQ;AAAA,EACb,MAAM,MAAM,SAAkB,KAA6B;AACzD,QAAI;AACF,YAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAE/B,UAAI,IAAI,aAAa,cAAc;AACjC,eAAO,IAAI,SAAS,aAAa,EAAE,QAAQ,IAAI,CAAC;AAAA,MAClD;AAEA,YAAM,SAAS,IAAI,2BAA2B;AAC9C,YAAM,eAAe,QAAQ,QAAQ,IAAI,WAAW,KAAK;AACzD,UAAI,CAAC,UAAU,CAAC,gBAAgB,WAAW,cAAc;AACvD,eAAO,IAAI,SAAS,KAAK,UAAU,EAAE,OAAO,eAAe,CAAC,GAAG;AAAA,UAC7D,QAAQ;AAAA,UACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,QAChD,CAAC;AAAA,MACH;AAEA,YAAM,UAAW,MAAM,QAAQ,KAAK,EAAE,MAAM,OAAO,CAAC,EAAE;AACtD,YAAM,QAAQ,OAAO,QAAQ,UAAU,WAAW,QAAQ,QAAQ;AAElE,UAAI,CAAC,OAAO;AACV,eAAO,IAAI,SAAS,KAAK,UAAU,EAAE,OAAO,gBAAgB,CAAC,GAAG;AAAA,UAC9D,QAAQ;AAAA,UACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,QAChD,CAAC;AAAA,MACH;AAEA,YAAM,eAAe,mBAAmB,KAAK;AAC7C,YAAM,SAAS,IAAI;AAEnB,YAAM,WAAW,MAAM,OAAO,IAAI,YAAY;AAC9C,UAAI,YAAY,SAAS,MAAM;AAC7B,cAAM,cAAc,eAAe,IAAI,oBAAoB,YAAY;AACvE,eAAO,IAAI,SAAS,KAAK,UAAU,EAAE,IAAI,MAAM,gBAAgB,YAAY,CAAC,GAAG;AAAA,UAC7E,QAAQ;AAAA,UACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,QAChD,CAAC;AAAA,MACH;AAEA,aAAO,IAAI;AAAA,QACT,KAAK,UAAU,EAAE,OAAO,6BAA6B,gBAAgB,aAAa,CAAC;AAAA,QACnF;AAAA,UACE,QAAQ;AAAA,UACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,QAChD;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,YAAM,UACJ,SAAS,OAAQ,MAAc,YAAY,WACtC,MAAc,UACf;AACN,aAAO,IAAI,SAAS,KAAK,UAAU,EAAE,OAAO,yBAAyB,QAAQ,QAAQ,CAAC,GAAG;AAAA,QACvF,QAAQ;AAAA,QACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAChD,CAAC;AAAA,IACH;AAAA,EACF;AACF;",
  "names": []
}
